# Basic Memory Cloud - POC Deployment Guide

This guide walks through deploying Basic Memory as a cloud MCP server with OAuth authentication to Fly.io. This is a POC (Proof of Concept) that validates remote MCP connections before building the full multi-tenant architecture.

## Overview

We're deploying the existing Basic Memory MCP server to the cloud with:
- **Remote HTTPS access** via Fly.io hosting
- **OAuth authentication** using Supabase Auth
- **HTTP transport** instead of stdio for web compatibility
- **Single-user setup** for initial validation

## Prerequisites

### Required Tools
- [Fly.io CLI](https://fly.io/docs/hands-on/install-flyctl/) installed and authenticated
- [Supabase account](https://supabase.com) (free tier works)
- Basic Memory repository cloned locally

### Required Accounts
- **Fly.io account** - For hosting the MCP server
- **Supabase account** - For OAuth authentication

## Phase 1: Fly.io Configuration (15 minutes)

### 1.1 Create fly.toml

Create a `fly.toml` file in the project root:

```toml
# fly.toml app configuration file
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.

app = "basic-memory-cloud-poc"
primary_region = "iad"

[build]

[env]
  # MCP Server Configuration
  FASTMCP_AUTH_ENABLED = "true"
  FASTMCP_AUTH_PROVIDER = "supabase"
  
  # Single project configuration for POC
  BASIC_MEMORY_DEFAULT_PROJECT = "main"
  BASIC_MEMORY_PROJECTS = '{"main": "/app/data"}'
  
  # Logging
  LOG_LEVEL = "INFO"

[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 0
  processes = ["app"]

  [[http_service.checks]]
    interval = "10s"
    timeout = "2s"
    grace_period = "5s"
    method = "GET"
    path = "/health"

[mounts]
  source = "basic_memory_data"
  destination = "/app/data"

[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512
```

### 1.2 Update Dockerfile

Modify the existing `Dockerfile` to use HTTP transport:

```dockerfile
# Generated by https://smithery.ai. See: https://smithery.ai/docs/config#dockerfile
FROM python:3.12-slim

WORKDIR /app

# Copy the project files
COPY . .

# Install pip and build dependencies
RUN pip install --upgrade pip \
&& pip install . --no-cache-dir --ignore-installed

# Create data directory for projects
RUN mkdir -p /app/data

# Expose port for HTTP transport
EXPOSE 8000

# Add health check endpoint
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

# Use HTTP transport for cloud deployment
CMD ["basic-memory", "mcp", "--transport", "streamable-http", "--host", "0.0.0.0", "--port", "8000"]
```

### 1.3 Add Health Check Endpoint

Create a simple health check by adding this to the MCP server. We'll add a basic health endpoint to the FastMCP server.

Note: For the POC, we can rely on the MCP endpoint itself for health checks, or skip this initially.

## Phase 2: Supabase Configuration (10 minutes)

### 2.1 Create Supabase Project

1. Go to [supabase.com](https://supabase.com)
2. Click "New Project"
3. Choose organization and name (e.g., "basic-memory-cloud")
4. Set database password (save this!)
5. Choose region (same as Fly.io for best performance)
6. Click "Create new project"

### 2.2 Configure Authentication

1. **Go to Authentication > Settings**
2. **Site URL**: Set to `https://your-app-name.fly.dev` (replace with your actual app name)
3. **Redirect URLs**: Add:
   - `https://your-app-name.fly.dev/auth/callback`
   - `http://localhost:8000/auth/callback` (for local testing)

### 2.3 Get Credentials

1. **Go to Settings > API**
2. **Copy these values**:
   - Project URL (starts with `https://`)
   - `anon` key (public key)
   - `service_role` key (secret key)

### 2.4 Enable OAuth Providers (Optional)

1. **Go to Authentication > Providers**
2. **Enable desired providers** (Google, GitHub, etc.)
3. **Configure each provider** with your OAuth app credentials

## Phase 3: Deployment (10 minutes)

### 3.1 Initialize Fly.io App

```bash
# Navigate to your basic-memory project
cd /path/to/basic-memory

# Create Fly.io app (this will update fly.toml with your app name)
fly launch --no-deploy

# Create persistent volume for data
fly volumes create basic_memory_data --region iad --size 1
```

result:
```
(basic-memory) ➜  basic-memory git:(cloud) ✗ fly volumes create basic_memory_data --region iad --size 1
Warning! Every volume is pinned to a specific physical host. You should create two or more volumes per application to avoid downtime. Learn more at https://fly.io/docs/volumes/overview/
? Do you still want to use the volumes feature? Yes
                  ID: vol_r1o7xjjlxezmyy94
                Name: basic_memory_data
                 App: basic-memory
              Region: iad
                Zone: 7c35
             Size GB: 1
           Encrypted: true
          Created at: 10 Jun 25 02:32 UTC
  Snapshot retention: 5
 Scheduled snapshots: true
```

## Supabase setup

Set up Supabase and get the credentials. Here's what to do:

  Set up Supabase:

  1. Go to https://supabase.com and create a new project
  2. Name it something like "basic-memory-cloud"
  3. Once created, go to Settings > API and copy:
    - Project URL
    - anon key
    - service_role key

set secrets
```
fly secrets set SUPABASE_URL="https://wrcoxyihzguzdbxypyyt.supabase.co"
fly secrets set SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyY294eWloemd1emRieHlweXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MDIxMDUsImV4cCI6MjA2NTE3ODEwNX0.BSAw-QIwFg6n45KtRG5tu4ivVly1aLVsrT9pPNt8gB4"
fly secrets set FASTMCP_AUTH_ISSUER_URL="https://basic-memory.fly.dev"
```

deploy
```
fly deploy
```



  Configure Supabase Auth:

  1. Go to Authentication > Settings
  2. Set Site URL to: https://basic-memory.fly.dev
  3. Add Redirect URLs:
    - https://basic-memory.fly.dev/auth/callback
    - http://localhost:8000/auth/callback (for local testing)

  3. Set the secrets in Fly.io:

### 3.2 Set Environment Variables

Replace the placeholder values with your actual Supabase credentials:

```bash
# Set Supabase configuration
fly secrets set SUPABASE_URL="https://your-project-id.supabase.co"
fly secrets set SUPABASE_ANON_KEY="your-anon-key"
fly secrets set SUPABASE_SERVICE_KEY="your-service-role-key"

# Set issuer URL (replace with your actual app name)
fly secrets set FASTMCP_AUTH_ISSUER_URL="https://your-app-name.fly.dev"

# Optional: Set required scopes
fly secrets set FASTMCP_AUTH_REQUIRED_SCOPES="read,write"
```

### 3.3 Deploy Application

```bash
# Deploy to Fly.io
fly deploy

# Check deployment status
fly status

# View logs
fly logs
```

### 3.4 Verify Deployment

```bash
# Check if app is running
curl https://your-app-name.fly.dev/mcp

# You should see MCP server response or OAuth redirect
```

## Phase 4: Testing (10 minutes)

### 4.1 Configure Claude for Remote MCP

Update your Claude configuration to connect to the remote server:

**For Claude Desktop**:
Add to your MCP settings (usually in `~/Library/Application Support/Claude/claude_desktop_config.json` on macOS):

```json
{
  "mcpServers": {
    "basic-memory-cloud": {
      "command": "npx",
      "args": [
        "@modelcontextprotocol/client-stdio",
        "https://your-app-name.fly.dev/mcp"
      ],
      "env": {}
    }
  }
}
```

**For Claude Code**:
```bash
# Connect using HTTP transport
claude-mcp connect https://your-app-name.fly.dev/mcp
```

### 4.2 Test OAuth Flow

1. **Connect to MCP server** - Claude should prompt for authentication
2. **Complete OAuth flow** - Browser should open to Supabase auth
3. **Verify tools work** - Try basic commands like listing notes

### 4.3 Test Basic Memory Tools

Try these commands in Claude to verify everything works:

```
# List current projects
Can you show me the current project status?

# Create a test note
Create a note called "Cloud Test" with content "Testing remote MCP deployment"

# Search functionality
Search for notes containing "test"

# Read the note back
Read the "Cloud Test" note
```

## Troubleshooting

### Common Issues

#### 1. Deployment Fails
```bash
# Check build logs
fly logs --app your-app-name

# Common fixes:
# - Ensure Dockerfile syntax is correct
# - Check that all dependencies install properly
# - Verify Python version compatibility
```

#### 2. OAuth Redirect Errors
- **Verify Supabase redirect URLs** include your Fly.io domain
- **Check FASTMCP_AUTH_ISSUER_URL** matches your actual Fly.io URL
- **Ensure HTTPS** is used for all URLs

#### 3. MCP Connection Issues
```bash
# Check server is responding
curl https://your-app-name.fly.dev/mcp

# Check logs for authentication errors
fly logs --app your-app-name

# Verify environment variables are set
fly ssh console --app your-app-name
env | grep SUPABASE
```

#### 4. Database/File Access Issues
```bash
# Check volume mount
fly ssh console --app your-app-name
ls -la /app/data

# Initialize project if needed
basic-memory init --project main --path /app/data
```

### Debug Commands

```bash
# SSH into running container
fly ssh console --app your-app-name

# Check running processes
fly ssh console --command "ps aux"

# View real-time logs
fly logs --app your-app-name -f

# Check environment variables
fly ssh console --command "env"
```

## Validation Checklist

- [ ] Fly.io app deploys successfully
- [ ] Health checks pass
- [ ] Supabase OAuth configured correctly
- [ ] MCP endpoint responds to HTTPS requests
- [ ] Claude can connect to remote MCP server
- [ ] OAuth flow completes successfully
- [ ] Basic Memory tools work remotely
- [ ] File operations persist across deployments

## Security Notes

### For POC
- Using single project with hardcoded path
- No multi-tenant isolation
- Service role key used for all operations
- No rate limiting or abuse protection

### For Production
- Implement proper user management
- Add tenant isolation
- Use row-level security in Supabase
- Add rate limiting and monitoring
- Implement proper logging and auditing

## Next Steps

Once the POC is working:

1. **Multi-tenant Architecture** - Implement User and Tenant models
2. **Enhanced Security** - Add role-based access control
3. **File Storage** - Move to cloud storage (S3/GCS)
4. **Monitoring** - Add application monitoring and alerting
5. **CI/CD** - Automate deployments with GitHub Actions
6. **GoHighLevel Integration** - Add CRM integration features

## Cost Estimation

### Fly.io (POC)
- **App**: Free tier (shared CPU, 256MB RAM)
- **Volume**: $0.15/GB/month (1GB = $0.15/month)
- **Total**: ~$0.15/month

### Supabase
- **Free tier**: 50MB database, 2GB bandwidth
- **Total**: $0/month for POC

### Estimated POC Cost: ~$0.15/month

## Support

For issues with this deployment:
1. Check the troubleshooting section above
2. Review Fly.io logs: `fly logs --app your-app-name`
3. Verify Supabase configuration
4. Test OAuth flow in isolation

This POC validates the core concept of remote Basic Memory with OAuth before building the full multi-tenant cloud architecture.